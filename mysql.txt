SELECT
    o.id,
    o.shipment,
    o.sku,
    o.no,
    o.num,
    o.depot,
    o.unit_price,
    o.total_price,
    i.SumInNum,
    o.Sumoutnum,
    i.unit_price,
    (
        SUM(
            (
                CASE
                WHEN i.SumInNum > o.Sumoutnum THEN
                    o.Sumoutnum
                ELSE
                    i.SumInNum
                END - CASE
                WHEN o.Sumoutnum - o.num > i.SumInNum - i.num THEN
                    o.Sumoutnum - o.num
                ELSE
                    i.SumInNum - i.num
                END
            ) * i.unit_price
        ) / o.num
    ) costprice,
    (
        SUM(
            (
                CASE
                WHEN i.SumInNum > o.Sumoutnum THEN
                    o.Sumoutnum
                ELSE
                    i.SumInNum
                END - CASE
                WHEN o.Sumoutnum - o.num > i.SumInNum - i.num THEN
                    o.Sumoutnum - o.num
                ELSE
                    i.SumInNum - i.num
                END
            ) * i.unit_price
        )
    ) costmoney
FROM
    (
        SELECT
            *, (
                SELECT
                    SUM(num)
                FROM
                    tao86_jppurchases
                WHERE
                    sku = i.sku
                AND depot = i.depot
                AND ver = (
                    SELECT
                        ver
                    FROM
                        tao86_v_jpversion v
                    WHERE
                        i.depot = v.depot
                )
                AND cdate <= i.cdate
            ) SumInNum
        FROM
            tao86_jppurchases AS i
    ) AS i,
    (
        SELECT
            *, (
                SELECT
                    SUM(num)
                FROM
                    tao86_jpsales
                WHERE
                    sku = i.sku
                AND depot = i.depot
                AND shipment >= (
                    SELECT
                        mdate
                    FROM
                        tao86_v_jpverdate v
                    WHERE
                        i.depot = v.depot
                )
                AND shipment <= i.shipment
            ) Sumoutnum
        FROM
            tao86_jpsales AS i
    ) AS o
WHERE
    i.sku = o.sku
AND i.SumInNum - i.num < o.Sumoutnum
AND o.Sumoutnum - o.num < i.SumInNum
AND o.sku = '4992440034713'
AND o.shipment >= '2018-01-01'
AND o.shipment <= '2018-09-01'
AND o.depot = 5
GROUP BY
    o.id,
    o.shipment,
    o.depot,
    o.sku,
    o.num,
    o.total_price
ORDER BY
    o.shipment DESC,
    o.id DESC